# Hooks

`Hooks` is a namespace providing React hook utilities for plugins. Instances are accessible through both the global `BdApi` and plugin-bound `BdApi` instances.

- Global/unbound: `BdApi.Hooks`
- Plugin-bound: `const {Hooks} = new BdApi("MyPlugin");`

## Properties

_None._

## Methods

### useStateFromStores

Subscribes to one or more Flux-like stores and derives React state from them. Re-renders the component when any of the stores change and the selected state changes.

| Parameter |       Type       | Optional | Default |                 Description                 |
|:----------|:-----------------|:--------:|:-------:|:-------------------------------------------|
stores|Array.&lt;Store&gt; \| Store|&#x274C;|*none*|One or more Flux-style stores to subscribe to|
getState|function|&#x274C;|*none*|Selector called after store changes to compute derived state|
deps|Array.&lt;any&gt;|&#x2705;|`[]`|Dependency array controlling when to recompute `getState`|
compare|function|&#x2705;|*none*|Optional `(prev, next) => boolean` to suppress updates|

**Returns:** `any` – The current derived state.

**Notes:**

- `stores` is commonly an array: `useStateFromStores([Store], selector)`.
- Fully compatible with Discord’s internal `useStateFromStores`.

___

### useForceUpdate

Returns a function that forces the component to re-render when called, even if props/state haven’t changed.

| Parameter |  Type  | Optional | Default | Description |
|:----------|:------:|:--------:|:-------:|:-----------|
*(none)*|—|—|—|—|

**Returns:** `[number, function]` – A `useReducer` tuple; destructure the second element to get the re-render callback (e.g. `const [, rerender] = Hooks.useForceUpdate()`).

___

### useData

Hook wrapper around BetterDiscord’s plugin data store (`JsonStore`). Subscribes to a specific plugin/key and re-renders the component whenever that value changes.

There are two calling forms depending on whether you use a plugin-bound API instance.

#### Bound (`new BdApi("MyPlugin")`)

| Parameter |  Type  | Optional | Default |               Description               |
|:----------|:------:|:--------:|:-------:|:----------------------------------------|
key|string|&#x274C;|*none*|Key under this plugin’s data namespace to subscribe to|

**Returns:** `any` – The current value for this plugin/key.

#### Unbound (`BdApi.Hooks`)

| Parameter |  Type  | Optional | Default |               Description               |
|:----------|:------:|:--------:|:-------:|:----------------------------------------|
pluginName|string|&#x274C;|*none*|Plugin name whose data you want to read|
key|string|&#x274C;|*none*|Key under that plugin’s data namespace|

**Returns:** `any` – The current value for `pluginName/key`.

**Notes:**

- Internally calls `JsonStore.useData(pluginName, key)`, which is a React hook.
- `useData` is read-only; use `BdApi.Data.save` / `BdApi.Data.delete` to write.

___

# Utils.Store

`Utils.Store` is a minimal store helper exposed under `BdApi.Utils`. It provides the subscription API expected by Flux-aware helpers such as `Hooks.useStateFromStores`. It does not manage state by itself; you add your own fields and call `emitChange()` after updates.

Accessible as: `BdApi.Utils.Store`.

## Properties

_None pre-defined._  
You are expected to add your own instance or subclass fields (e.g. `this.data`, `this.count`, etc.).

## Methods

### constructor

Creates a new store instance.

| Parameter | Type | Optional | Default | Description |
|:----------|:----:|:--------:|:-------:|:-----------|
*(none)*|—|—|—|—|

**Returns:** `Store` – A new store instance.

___

### initialize

Optional lifecycle hook. The base implementation is a no-op.

| Parameter | Type | Optional | Default | Description |
|:----------|:----:|:--------:|:-------:|:-----------|
*(none)*|—|—|—|—|

**Returns:** `void`

___

### addChangeListener

Registers a listener that will be called whenever `emitChange()` is invoked. Returns an unsubscribe function.

| Parameter |     Type     | Optional | Default |                 Description                  |
|:----------|:------------:|:--------:|:-------:|:--------------------------------------------|
listener|function|&#x274C;|*none*|Callback invoked with no arguments on change|

**Returns:** `function` – A function that removes this listener when called.

___

### removeChangeListener

Removes a previously added listener.

| Parameter |     Type     | Optional | Default |         Description          |
|:----------|:------------:|:--------:|:-------:|:----------------------------|
listener|function|&#x274C;|*none*|Listener originally passed to `addChangeListener`|

**Returns:** `void`

Calling `removeChangeListener` with an unknown listener is a no-op.

___

### emitChange

Notifies all registered listeners that the store’s state has changed.

| Parameter | Type | Optional | Default | Description |
|:----------|:----:|:--------:|:-------:|:-----------|
*(none)*|—|—|—|—|

**Returns:** `void`

**Notes:**

- Always call `emitChange()` after mutating any observable state (e.g. changing `this.data`, `this.count`, etc.) so that `useStateFromStores` subscribers re-render.

___

# Data Events (Experimental)

> **Status:** `BdApi.Data.on` and `BdApi.Data.off` are **commented out** in `src/betterdiscord/api/data.ts` in this commit. They are not officially available in this snapshot, but the stubs show the intended design.

If enabled, `Data.on`/`off` would register change listeners on plugin data keys, delegating to `JsonStore.addPluginChangeListener` / `removePluginChangeListener`.

## Intended Signatures (from stubs, not yet active)

Using a plugin-bound API (`new BdApi("MyPlugin")`):

### Data.on (per key)

```ts
api.Data.on<T>(key: string, onChange: (value?: T) => void): void;
```

### Data.on (all keys)

```ts
api.Data.on<T>(onChange: (key: string, value?: T) => void): void;
```

Using the unbound singleton (`BdApi.Data`):

### Data.on (per key)

```ts
BdApi.Data.on<T>(
  pluginName: string,
  key: string,
  onChange: (value?: T) => void
): void;
```

### Data.on (all keys)

```ts
BdApi.Data.on<T>(
  pluginName: string,
  onChange: (key: string, value?: T) => void
): void;
```

`Data.off` mirrors the above signatures to remove listeners.

**Listener callback signature:**

- Per key: `(value?: T) => void`.
- All keys: `(key: string, value?: T) => void`.

**Triggers:**

- `Data.save` → `JsonStore.setData` → would trigger listeners.
- `Data.delete` → `JsonStore.deleteData` → would trigger with `undefined`.

**Implementation status:** Commented out in `Data` for this commit; consider these **experimental / planned**, not guaranteed.

___

# Webpack

`Webpack` is a utility namespace for accessing internal Discord webpack modules. Instance is accessible through `BdApi.Webpack`.

This section only documents the newly added or updated helpers.

## Methods

### getBulk

Collects multiple modules in a single pass, based on a set of filter queries. Returns an array of results corresponding to each query.

```ts
BdApi.Webpack.getBulk<T extends any[]>(...queries: BulkQueries[]): T;
```

Where `BulkQueries` is:

```ts
type BulkQueries = {
  filter: Filter;
  all?: boolean;
  map?: Record<string, ExportedOnlyFilter>;
  searchExports?: boolean;
  defaultExport?: boolean;
  searchDefault?: boolean;
  raw?: boolean;
  fatal?: boolean;
};
```

**Returns:** `Array` – Matches per query, shaped according to `all` and `map` settings.

(Full `getBulk` details are beyond this doc; it was present pre-1.13.)

___

### getBulkKeyed

**(Likely what PR called “getBulkObject”)**

`getBulkKeyed` performs a bulk search like `getBulk`, but uses an object of named queries and returns an object of results keyed the same way.

```ts
BdApi.Webpack.getBulkKeyed<T extends object>(
  queries: Record<keyof T, BulkQueries>
): T;
```

**Parameters:**

| Parameter |    Type    | Optional | Default |             Description              |
|:----------|:----------:|:--------:|:-------:|:-------------------------------------|
queries|Record&lt;keyof T, BulkQueries&gt;|&#x274C;|*none*|Object whose keys name each query|

**Returns:** `T` – Object whose keys mirror `queries` keys, values are the resolved modules.

**Status:** Implemented as `getBulkKeyed`; there is **no** separate `getBulkObject` function in this commit.

___

### Filters.not

Generates a filter that returns the logical negation of another filter.

```ts
BdApi.Webpack.Filters.not(filter: Filter): Filter;
```

**Parameters:**

| Parameter |  Type  | Optional | Default |              Description              |
|:----------|:------:|:--------:|:-------:|:--------------------------------------|
filter|Filter|&#x274C;|*none*|Existing module filter to negate|

**Returns:** `Filter` – A filter that returns `!filter(exports, module, id)`.

**Usage example:**

```ts
const {Webpack} = BdApi;

const hasFoo = Webpack.Filters.byKeys("foo");
const doesNotHaveFoo = Webpack.Filters.not(hasFoo);

const mod = Webpack.getModule(doesNotHaveFoo);
```

___

### Filters.byComponentType

Generates a filter that operates on the **unwrapped React component type** (function component), independent of memo/forwardRef/lazy wrappers.

```ts
BdApi.Webpack.Filters.byComponentType(
  filter: (component: any) => boolean
): (exports: any) => boolean;
```

**Parameters:**

| Parameter |       Type       | Optional | Default |                Description                |
|:----------|:-----------------|:--------:|:-------:|:------------------------------------------|
filter|function|&#x274C;|*none*|Predicate that receives the unwrapped component type|

**Returns:** `ExportedOnlyFilter` – Filter suitable for use with `Webpack.getModule`.

**Behavior:**

- Calls `BdApi.ReactUtils.getType(exports)` to unwrap:
  - `React.memo`
  - `React.forwardRef`
  - `React.lazy`
- Passes the inner component type to your `filter`.
- Returns `true` only if:
  - The inner type is a function, and
  - `filter(component)` returns `true`.

**Usage example:**

```ts
const {Webpack} = BdApi;

const isFancy = Webpack.Filters.byComponentType(
  c => c.displayName === "FancyButton" || c.name === "FancyButton"
);

const FancyButtonModule = Webpack.getModule(isFancy, {searchExports: true});
```

___

### getById

Gets a module directly by its webpack ID.

```ts
BdApi.Webpack.getById<T = any>(id: PropertyKey): T | undefined;
```

**Parameters:**

| Parameter |   Type    | Optional | Default |      Description      |
|:----------|:---------:|:--------:|:-------:|:----------------------|
id|PropertyKey|&#x274C;|*none*|Internal webpack module ID|

**Returns:** `any` – Exported module value, or `undefined` if not found or skippable.

**Notes:**

- Internally supports `raw` and `fatal` options, but these are **not** exposed on the BdApi wrapper in this commit.
- Internal behavior (`getById(id, {raw, fatal})`):
  - If module exists and is not “skipped”, returns either:
    - `module.exports` (`raw: false`), or
    - `module` (`raw: true`).
  - If missing/skippable and `fatal: true`, throws an error.
  - Otherwise returns `undefined`.

___

### `fatal` option on search helpers

`fatal?: boolean` is part of the core `Webpack.Options`. It is honored by the internal helpers:

- `getModule(filter, {fatal: true})` – Throws if no module matches.
- `getAllModules(filter, {fatal: true})` – Throws if no modules match.
- `getById(id, {fatal: true})` – Throws if the module is missing or skippable.

The BdApi wrappers (e.g. `BdApi.Webpack.getModule`, `getByKeys`, `getByStrings`, etc.) pass options through, so you can use `fatal` there as well:

```ts
const mod = BdApi.Webpack.getModule(filter, {fatal: true});
```

**Behavior on failure:**

- Throws a generic “module not found”-style `Error` created by an internal `makeException()` helper.

___

# ReactUtils

`ReactUtils` is a utility namespace for interacting with React internals. Instance is accessible through `BdApi.ReactUtils`.

## Properties

### rootInstance

> **Deprecated.**

Returns the root React fiber for the `#app-mount` container in the current render tree.

| Property      |   Type   | Description                              |
|:--------------|:--------:|:-----------------------------------------|
rootInstance|getter|Internal React root fiber (if available), or `undefined`|

___

## Methods

### getType

Unwraps React “exotic” components (memo/forwardRef/lazy) to return the underlying function component type.

```ts
BdApi.ReactUtils.getType<T extends React.FC>(
  elementType: ElementType<T>
): T;
```

Where `ElementType<T>` includes:

- `T` (function component),
- `React.MemoExoticComponent`,
- `React.ForwardRefExoticComponent`,
- `React.LazyExoticComponent` of the above.

**Parameters:**

| Parameter   |   Type   | Optional | Default |              Description              |
|:------------|:--------:|:--------:|:-------:|:--------------------------------------|
elementType|ElementType&lt;T&gt;|&#x274C;|*none*|Component type (possibly wrapped) to unwrap|

**Returns:** `T` – The inner function component.

**Usage example:**

```ts
const type = BdApi.ReactUtils.getType(SomeMemoOrForwardRefComponent);
// `type` is now the raw function component.
```

___

### wrapElement

Creates a React class component that wraps one or more existing DOM elements, mounting them into a `<div>` when rendered and unmounting them when the React tree unmounts.

```ts
BdApi.ReactUtils.wrapElement(
  element: Element | Element[]
): React.ComponentType;
```

(Not new, but related to internals.)

___

### wrapInHooks

Wraps a function component so that, during its render, React’s internal hooks dispatcher is patched with BetterDiscord’s custom `patchedReactHooks` (plus any `customPatches`). This allows components that use newer hooks (e.g. `React.use`, `useFormState`, `useOptimistic`, etc.) to run safely even in older environments.

```ts
BdApi.ReactUtils.wrapInHooks<T extends React.FC>(
  functionComponent: T | React.MemoExoticComponent<any> | React.ForwardRefExoticComponent<any>,
  customPatches?: Partial<PatchedReactHooks>
): React.FunctionComponent<React.ComponentProps<T>>;
```

**Parameters:**

| Parameter         |                  Type                  | Optional | Default |                       Description                        |
|:------------------|:--------------------------------------:|:--------:|:-------:|:--------------------------------------------------------|
functionComponent|React.FC \| memo \| forwardRef|&#x274C;|*none*|Component to render under patched hooks                  |
customPatches|Partial&lt;PatchedReactHooks&gt;|&#x2705;|`{}`|Overrides for the default patched hooks for this render |

**Returns:** `function` – A new function component that can be rendered in place of the original.

**Behavior:**

1. Calls `ReactUtils.getType(functionComponent)` to get the actual function component.
2. Reads the internal React dispatcher: `React.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE.H`.
3. Saves a shallow copy of the dispatcher.
4. Overlays:
   - BD’s `patchedReactHooks` (providing implementations/stubs for many hooks).
   - Any `customPatches` you provide.
5. Calls the component with your props.
6. If a `React` “invalid hook usage” error `#460` is thrown, swallows it (returns `undefined`).
7. Restores the original dispatcher.

**Usage example:**

```tsx
const Internal = BdApi.Webpack.getModule(/* some filter returning a React component */);
const Wrapped = BdApi.ReactUtils.wrapInHooks(Internal);

function MyPluginComponent() {
  return <Wrapped someProp="value" />;
}
```

**When to use:**

- When rendering Discord/BD internal components that rely on newer or unusual hook usage that might otherwise produce “minified React error #460” or similar.
- When needing temporary custom hook behavior for a specific component.

___

### forceUpdateFiber

> **Status:** Not implemented in this commit.

There is commented-out code for a `forceUpdateFiber(fiber: Fiber): boolean` method, but it is:

- Not part of the `ReactUtils` interface.
- Not attached to the exported `ReactUtils` object.

You should **not** rely on `BdApi.ReactUtils.forceUpdateFiber` in this version.

___

# UI – Notification API

In addition to `UI.showToast` and `UI.showNotice`, BetterDiscord 1.13 adds a rich in-app notification API:

## Methods

### showNotification

Shows a card-style notification in-app with title, markdown content, icon, buttons, timeout/progress, and close behavior.

```ts
BdApi.UI.showNotification(notification: Notification): {
  id: string;
  isVisible(): boolean;
  close(): void;
} | undefined;
```

**Parameters:**

| Parameter      |        Type        | Optional | Default |                    Description                    |
|:---------------|:------------------:|:--------:|:-------:|:--------------------------------------------------|
notification|Notification|&#x274C;|*none*|Notification configuration object (see below)|

**Notification fields (merged with defaults):**

Defaults in `src/betterdiscord/api/ui.ts`:

```ts
const defaultObj = {
  title: "",
  content: "",
  type: "info" as const,
  duration: 5000,
  icon: null,
  actions: []
};
```

Supported fields:

- `id?: string` – Unique ID; if omitted, the store will generate one.
- `title?: string` – Optional title text.
- `content?: string | ReactElement` – Body content:
  - Strings are rendered via Markdown.
  - React elements are rendered in an `ErrorBoundary`.
- `type?: "info" | "success" | "error" | "warning"` – Controls icon and colors.
- `duration?: number` – Milliseconds for the auto-dismiss/progress bar.
- `icon?: React.ComponentType` – Custom icon component to use instead of the default.
- `actions?: Array<{
    label: string;
    onClick?: (event: MouseEvent) => void;
    dontClose?: boolean;
    dontCloseOnActionIfHoldingShiftKey?: boolean;
    color?: string;
    look?: string;
  }>` – Footer buttons.
- `onClose?: () => void` – Called when the notification is closed (timeout, close button, or action click if it closes).

**Return value:**

- An object `{id, isVisible, close}` if notifications are enabled.
- `undefined` if `"settings" → "general" → "notificationEnabled"` is disabled.

**Behavior and visuals:**

- Notifications are rendered by a persistent React root into `#bd-notifications-container`.
- Position is controlled by the setting `notificationPosition` (`bd-notification-top-right`, etc.).
- Card layout:
  - Icon + title in header.
  - Markdown content or JSX body.
  - Optional action buttons in footer.
  - Close (✕) in the corner.
  - Progress bar underneath:
    - Animates from full width to 0 over `duration`.
    - Pauses on hover.
    - Color based on `type`.

**Comparison to `showToast`/`showNotice`:**

- `showToast` – small, bottom-of-screen string-only toast with optional icon and timeout.
- `showNotice` – thin bar above chat, string content + simple buttons.
- `showNotification` – full card, rich content, multi-action, progress, hover pause, and icon customization.
